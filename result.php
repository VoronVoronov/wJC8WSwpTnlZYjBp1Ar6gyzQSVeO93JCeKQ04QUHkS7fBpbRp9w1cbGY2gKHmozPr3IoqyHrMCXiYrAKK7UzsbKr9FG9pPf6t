<?php
	error_reporting(1);
	$payment = $_GET['payment'];

	$config = array(
		'db' => array(
			'host' => "localhost",
			'user' => 'ipdonate.com',
			'pass' => '4G1w2Z1c',
			'base' => 'ipdonate.com',
			'prefix' => 'gd_',
		),
	);

	$db = new mysqli($config['db']['host'], $config['db']['user'], $config['db']['pass'], $config['db']['base']);
	$db->set_charset("utf8");

	if($db->connect_errno) {
	    exit('<center>Идут технические работы.</center>');
	}
	switch ($payment) {
		case 'handlerQIWI':
	    $secretKey = 'eyJ2ZXJzaW9uIjoiUDJQIiwiZGF0YSI6eyJwYXlpbl9tZXJjaGFudF9zaXRlX3VpZCI6Im0xemlkci0wMCIsInVzZXJfaWQiOiI3OTY0MzY0MTEwMCIsInNlY3JldCI6IjNjNjk3YmE5NzAzYzNlOWQxYTczMDQyYjhiZjZjMmMxNTk1MDUxYTBmYWFlNzY4OGFlYTgyNDEzNjcwNWVjZTkifX0=';		
 	    require_once($_SERVER['DOCUMENT_ROOT'] . '/vendor/autoload.php'); // Require autoload file generated by composer
		$log_file = fopen($_SERVER['DOCUMENT_ROOT'] . '/qiwi.txt', 'a+');
		fwrite($log_file, print_r(json_decode(file_get_contents('php://input')), true).PHP_EOL);
		fwrite($log_file, print_r(getallheaders(), true).PHP_EOL);
		fclose($log_file);	
	    $billPayments = new Qiwi\Api\BillPayments($secretKey);   
		$postData = file_get_contents('php://input');
        $data = json_decode($postData, 1);
	    $donation_sql = $db->query('SELECT * FROM `donations` WHERE `donation_id` = '.$data['bill']['customer']['account']);
	    	while ($donation = mysqli_fetch_assoc($donation_sql)) {
	            if($data['bill']['status']['value'] == 'PAID'){
	                $validSignatureFromNotificationServer = $_SERVER['HTTP_X_API_SIGNATURE_SHA256'];
	                $notificationData = [
	                  'bill' => [
	                    'siteId' => '2304',
	                    'billId' =>  $donation['donation_id'].'-'.hash('sha256', $donation['donation_id'].'RUB'.$donation['donation_ammount'].$donation['donation_create_time']).'-'.$donation['user_id'],
	                    'amount' => ['value' => $data['bill']['amount']['value'], 'currency' => 'RUB'],
	                    'status' => ['value' => 'PAID']
	                  ],
	                  'version' => '3'
	                ];

	                $billPayments->checkNotificationSignature(
	                  $validSignatureFromNotificationServer, $notificationData, $secretKey
	                ); 
	                if ($donation['donation_id'] == $data['bill']['customer']['account']  && $donation['donation_status'] == 0) {     
	                	file_get_contents('https://ipdonate.com/qiwi/handler?params[donation_id]='.$donation['donation_id']);
	        		}
        		}
       		}
			break;


		case 'handlerYoomoney':
		    $secretKey = '8gUimObg0EJKQS8/jA3FjU48';		
	        if($_SERVER['REQUEST_METHOD'] == 'POST') {

	            $sha1 = sha1($_POST['notification_type'].'&'.
	                $_POST['operation_id'].'&'.
	                $_POST['amount'].'&'.
	                $_POST['currency'].'&'.
	                $_POST['datetime'].'&'.
	                $_POST['sender'].'&'.
	                $_POST['codepro'].'&'.
	                $secretKey.'&'.
	                $_POST['label']);
					$label = explode(":", $_POST['label']);
					$invid = $label[0];
					$ammount = $label[1];  
				    $log_file = fopen($_SERVER['DOCUMENT_ROOT'] . '/yandex.txt', 'a+');
				    fwrite($log_file, print_r(json_decode(file_get_contents('php://input')), true).PHP_EOL);
				    fwrite($log_file, print_r(getallheaders(), true).PHP_EOL);
				    fclose($log_file);				
		            if($sha1 == $_POST['sha1_hash']) {
					    $donation_sql = $db->query('SELECT * FROM `donations` WHERE `donation_id` = '.$invid);
					    	while ($donation = mysqli_fetch_assoc($donation_sql)) {
					                if ($donation['donation_id'] == $invid  && $donation['donation_status'] == 0) {     
					                	file_get_contents('https://ipdonate.com/yoomoney/handler?params[donation_id]='.$donation['donation_id']);
				        		}
			       		}
	       		}
	       	}
		break;

		case 'handlerWebmoney':
            function getIP() {
                if(isset($_SERVER['HTTP_X_REAL_IP'])) return $_SERVER['HTTP_X_REAL_IP'];
                return $_SERVER['REMOTE_ADDR'];
            }
                if (!in_array(getIP(), array('91.232.115.49'))) {
                    //die("hacking attempt!");
                header('Location: https://ipdonate.com/');
            }
	        $key = hash('sha256', 'P050915098697'.$_POST['LMI_PAYMENT_AMOUNT'].$_POST['LMI_PAYMENT_NO'].$_POST['LMI_MODE'].$_POST['LMI_SYS_INVS_NO'].$_POST['LMI_SYS_TRANS_NO'].$_POST['LMI_SYS_TRANS_DATE'].'UoPyhd5I7XI2WSuvPIBkHVI0'.$_POST['LMI_PAYER_PURSE'].$_POST['LMI_PAYER_WM']);
			$log_file = fopen($_SERVER['DOCUMENT_ROOT'] . '/webmoney.txt', 'a+');
			fwrite($log_file, print_r(json_decode(file_get_contents('php://input')), true).PHP_EOL);
			fwrite($log_file, print_r(getallheaders(), true).PHP_EOL);
			fclose($log_file);	
	        if(strtoupper($key) != $_POST['LMI_HASH'])
	            exit;
			$donation_sql = $db->query('SELECT * FROM `donations` WHERE `donation_id` = '.$_POST['LMI_PAYMENT_NO']);
				while ($donation = mysqli_fetch_assoc($donation_sql)) {
					if ($donation['donation_id'] == $_POST['LMI_PAYMENT_NO']  && $donation['donation_status'] == 0) {     
					    file_get_contents('https://ipdonate.com/webmoney/handler?params[donation_id]='.$donation['donation_id']);
				    }
				}
			break;

		case 'handlerPaypal':
	        $key = hash('sha256', 'P050915098697'.$_POST['LMI_PAYMENT_AMOUNT'].$_POST['LMI_PAYMENT_NO'].$_POST['LMI_MODE'].$_POST['LMI_SYS_INVS_NO'].$_POST['LMI_SYS_TRANS_NO'].$_POST['LMI_SYS_TRANS_DATE'].'UoPyhd5I7XI2WSuvPIBkHVI0'.$_POST['LMI_PAYER_PURSE'].$_POST['LMI_PAYER_WM']);
			$log_file = fopen($_SERVER['DOCUMENT_ROOT'] . '/paypal.txt', 'a+');
			fwrite($log_file, print_r(json_decode(file_get_contents('php://input')), true).PHP_EOL);
			fwrite($log_file, print_r(getallheaders(), true).PHP_EOL);
			fclose($log_file);	
	        if(strtoupper($key) != $_POST['LMI_HASH'])
	            exit;
			$donation_sql = $db->query('SELECT * FROM `donations` WHERE `donation_id` = '.$_POST['LMI_PAYMENT_NO']);
				while ($donation = mysqli_fetch_assoc($donation_sql)) {
					if ($donation['donation_id'] == $_POST['LMI_PAYMENT_NO']  && $donation['donation_status'] == 0) {     
					    file_get_contents('https://ipdonate.com/paypal/handler?params[donation_id]='.$donation['donation_id']);
				    }
				}
			break;

		default:
			return header('Location: /');;
			break;
	}
?>